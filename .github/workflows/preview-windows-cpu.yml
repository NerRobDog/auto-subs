name: Preview Windows CPU Build

on:
  push:
    branches:
      - codex/windows-cpu-build
  workflow_dispatch:
    inputs:
      ref:
        description: Git ref to build
        required: false
        default: main
        type: string

permissions:
  contents: read

jobs:
  build-windows-cpu:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: AutoSubs-App/package-lock.json

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install dependencies
        working-directory: AutoSubs-App
        run: npm install

      - name: Download ffmpeg sidecars
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location "AutoSubs-App/src-tauri"
          New-Item -ItemType Directory -Force -Path "binaries" | Out-Null
          Set-Location "binaries"

          gh release download `
            --repo tmoroney/ffmpeg-binaries `
            --pattern "ffmpeg-x86_64-pc-windows-msvc.zip" `
            --clobber

          Expand-Archive -Path "ffmpeg-x86_64-pc-windows-msvc.zip" -DestinationPath "." -Force
          Remove-Item "ffmpeg-x86_64-pc-windows-msvc.zip" -Force

          $ffmpeg = Get-ChildItem -Recurse -File -Filter "ffmpeg-x86_64-pc-windows-msvc.exe" |
            Where-Object { $_.FullName -notmatch "__MACOSX" } |
            Select-Object -First 1
          $ffprobe = Get-ChildItem -Recurse -File -Filter "ffprobe-x86_64-pc-windows-msvc.exe" |
            Where-Object { $_.FullName -notmatch "__MACOSX" } |
            Select-Object -First 1

          if (-not $ffmpeg) {
            throw "ffmpeg Windows sidecar not found after extraction"
          }
          if (-not $ffprobe) {
            throw "ffprobe Windows sidecar not found after extraction"
          }

          Move-Item $ffmpeg.FullName ".\\ffmpeg-x86_64-pc-windows-msvc.exe" -Force
          Move-Item $ffprobe.FullName ".\\ffprobe-x86_64-pc-windows-msvc.exe" -Force
          Get-ChildItem

      - name: Build unsigned Windows installer
        working-directory: AutoSubs-App
        shell: pwsh
        env:
          RUSTFLAGS: -C target-feature=-crt-static
          CFLAGS_x86_64_pc_windows_msvc: /MD
          CXXFLAGS_x86_64_pc_windows_msvc: /MD
        run: |
          @'
          {
            "bundle": {
              "createUpdaterArtifacts": false,
              "windows": {
                "certificateThumbprint": null,
                "timestampUrl": null,
                "signCommand": null
              }
            }
          }
          '@ | Set-Content -Path "src-tauri/tauri.preview.windows.conf.json" -Encoding utf8

          Write-Host "CRT variant: dynamic-crt-cc-md"
          Write-Host "RUSTFLAGS=$env:RUSTFLAGS"
          Write-Host "CFLAGS_x86_64_pc_windows_msvc=$env:CFLAGS_x86_64_pc_windows_msvc"
          Write-Host "CXXFLAGS_x86_64_pc_windows_msvc=$env:CXXFLAGS_x86_64_pc_windows_msvc"

          npx tauri build -b nsis -c src-tauri/tauri.preview.windows.conf.json -- --no-default-features

      - name: Stage Windows artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $bundleDir = "AutoSubs-App/src-tauri/target/release/bundle/nsis"
          $artifactDir = "preview-artifacts"
          New-Item -ItemType Directory -Force -Path $artifactDir | Out-Null

          $installer = Get-ChildItem $bundleDir -Filter "*.exe" | Select-Object -First 1
          if (-not $installer) {
            throw "Windows installer not found in $bundleDir"
          }

          Copy-Item $installer.FullName (Join-Path $artifactDir "AutoSubs-windows-cpu.exe")

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: autosubs-windows-cpu
          path: preview-artifacts/*
          if-no-files-found: error
