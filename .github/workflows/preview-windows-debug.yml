name: Preview Windows Debug

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Git ref to build
        required: false
        default: main
        type: string

permissions:
  contents: read

jobs:
  build-windows:
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: cpu
            artifact_suffix: windows-cpu
            tauri_args: -- --no-default-features
            use_vulkan: false
          - variant: gpu
            artifact_suffix: windows-gpu
            tauri_args: -- --no-default-features --features windows
            use_vulkan: true

    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: AutoSubs-App/package-lock.json

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install dependencies
        working-directory: AutoSubs-App
        run: npm install

      - name: Download ffmpeg sidecars
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = "Stop"
          Set-Location "AutoSubs-App/src-tauri"
          New-Item -ItemType Directory -Force -Path "binaries" | Out-Null
          Set-Location "binaries"

          gh release download `
            --repo tmoroney/ffmpeg-binaries `
            --pattern "ffmpeg-x86_64-pc-windows-msvc.zip" `
            --clobber

          Expand-Archive -Path "ffmpeg-x86_64-pc-windows-msvc.zip" -DestinationPath "." -Force
          Remove-Item "ffmpeg-x86_64-pc-windows-msvc.zip" -Force

          $ffmpeg = Get-ChildItem -Recurse -File -Filter "ffmpeg-x86_64-pc-windows-msvc.exe" |
            Where-Object { $_.FullName -notmatch "__MACOSX" } |
            Select-Object -First 1
          $ffprobe = Get-ChildItem -Recurse -File -Filter "ffprobe-x86_64-pc-windows-msvc.exe" |
            Where-Object { $_.FullName -notmatch "__MACOSX" } |
            Select-Object -First 1

          if (-not $ffmpeg) {
            throw "ffmpeg Windows sidecar not found after extraction"
          }
          if (-not $ffprobe) {
            throw "ffprobe Windows sidecar not found after extraction"
          }

          Move-Item $ffmpeg.FullName ".\\ffmpeg-x86_64-pc-windows-msvc.exe" -Force
          Move-Item $ffprobe.FullName ".\\ffprobe-x86_64-pc-windows-msvc.exe" -Force
          Get-ChildItem

      - name: Install Vulkan SDK
        if: matrix.use_vulkan
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          cache: true

      - name: Verify Vulkan SDK
        if: matrix.use_vulkan
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if (-not $env:VULKAN_SDK) {
            throw "VULKAN_SDK is not set"
          }
          Write-Host "VULKAN_SDK=$env:VULKAN_SDK"
          & "$env:VULKAN_SDK\Bin\glslc.exe" --version

      - name: Build unsigned Windows installer
        working-directory: AutoSubs-App
        shell: pwsh
        run: |
          @'
          {
            "bundle": {
              "createUpdaterArtifacts": false,
              "windows": {
                "certificateThumbprint": null,
                "timestampUrl": null,
                "signCommand": null
              }
            }
          }
          '@ | Set-Content -Path "src-tauri/tauri.preview.windows.conf.json" -Encoding utf8

          npx tauri build -b nsis -c src-tauri/tauri.preview.windows.conf.json ${{ matrix.tauri_args }}

      - name: Stage Windows artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $bundleDir = "AutoSubs-App/src-tauri/target/release/bundle/nsis"
          $artifactDir = "preview-artifacts"
          New-Item -ItemType Directory -Force -Path $artifactDir | Out-Null

          $installer = Get-ChildItem $bundleDir -Filter "*.exe" | Select-Object -First 1
          if (-not $installer) {
            throw "Windows installer not found in $bundleDir"
          }

          Copy-Item $installer.FullName (Join-Path $artifactDir "AutoSubs-${{ matrix.artifact_suffix }}.exe")

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: autosubs-${{ matrix.artifact_suffix }}
          path: preview-artifacts/*
          if-no-files-found: error
